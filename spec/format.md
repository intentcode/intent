# Codetale Intent Format Specification

## Overview

`.intent.md` files provide human-readable narratives explaining code changes. They are generated by coding agents alongside code modifications.

## File Location

```
repo/
├── .intent/
│   └── src/
│       └── cleaner.py.md    # Intent for src/cleaner.py
├── src/
│   └── cleaner.py
```

Each source file `path/to/file.ext` has a corresponding `.intent/path/to/file.ext.md`.

## Format Structure

```markdown
# {filename}

## {YYYY-MM-DD HH:MM} | {Session Title}

### Recap
**Objectif:** {What this session accomplishes}
**Risque:** {Faible|Moyen|Élevé} - {Why}

### Chunks

#### L{start}-{end} | {Chunk Title}
{Description of what this chunk does}
> Décision: {Key decision made and why}
> Décision: {Another decision if applicable}

#### L{start}-{end} | {Another Chunk}
{Description}

---

## {Previous Session Date} | {Title}
...
```

## Fields

### Session Header
- **Date/Time:** When the changes were made
- **Title:** Brief description of the session's goal

### Recap Section
- **Objectif:** High-level goal of this change session
- **Risque:** Risk assessment (Faible/Moyen/Élevé) with justification

### Chunks
Each chunk maps to a contiguous block of changed lines:
- **Line Range:** `L{start}-{end}` - Maps to diff line numbers
- **Title:** Short name for this chunk
- **Description:** What the code does and why
- **Décisions:** Key decisions made (prefixed with `>`)

## Example

```markdown
# cleaner.py

## 2024-01-11 14:30 | Ajout feature claude note

### Recap
**Objectif:** Sauvegarder le contexte des messages marqués "claude note" avant suppression
**Risque:** Faible - Ajout pur, ne modifie pas la logique existante

### Chunks

#### L14-21 | Dataclass Note
Structure pour stocker les notes capturées: timestamp, texte du marker, messages de contexte, flag thread.
> Décision: Dataclass plutôt que dict pour la clarté et le typage

#### L40-41 | Initialisation liste notes
Liste vide initialisée dans __init__ pour accumuler les notes pendant le cleanup.

#### L77-78 | Capture pendant le scan
Appel de la méthode de capture pendant le scan existant des messages.
> Décision: Pas de 2ème passe sur les messages, capture au fil de l'eau pour performance

#### L201-234 | Méthode _capture_notes_from_messages
Détecte "claude note" dans le texte, récupère les 2 messages précédents comme contexte.
> Décision: Détection case-insensitive pour flexibilité utilisateur
> Décision: Inclure le parent du thread comme fallback si pas assez de contexte dans les replies

---
```

## Viewer Mapping

The viewer maps chunks to diff hunks by line numbers:

```
┌─────────────────────────┬────────────────────────────────┐
│ Diff                    │ Intent                         │
├─────────────────────────┼────────────────────────────────┤
│ @@ -14,0 +14,8 @@       │ L14-21 | Dataclass Note        │
│ +@dataclass             │                                │
│ +class Note:            │ Structure pour stocker les     │
│ +    timestamp: ...     │ notes capturées...             │
│                         │                                │
│                         │ > Décision: Dataclass plutôt   │
│                         │   que dict pour la clarté      │
└─────────────────────────┴────────────────────────────────┘
```

## Guidelines for Agents

When generating `.intent.md` files:

1. **Create/update** the intent file for each modified source file
2. **Append** new sessions, don't overwrite history
3. **Be concise** but capture the "why", not just the "what"
4. **Document decisions** that aren't obvious from the code
5. **Assess risk** honestly to help reviewers prioritize
6. **Use line numbers** that match the final state of the file
